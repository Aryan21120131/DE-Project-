CREATE OR REPLACE PROCEDURE FIN_A.RAW.TEMP_CUSTOMER_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '  
    BEGIN

        DELETE FROM FIN_A.TRA.DIM_CUSTOMER;
        
        INSERT INTO FIN_A.TRA.DIM_CUSTOMER
        SELECT R.CUSTOMER_ID,R.CUSTOMER_NAME,R.CUSTOMER_TYPE,R.DATE_OF_BIRTH,R.GENDER,R.PAN_NUMBER,R.AADHAAR_NUMBER,R.EMAIL,R.MOBILE_NUMBER,
        R.ADDRESS,R.CITY,R.STATE,R.COUNTRY,R.RISK_CATEGORY,
            CASE 
                WHEN C.CUSTOMER_ID IS NULL THEN ''I''
                WHEN C.CUSTOMER_ID IS NOT NULL AND HASH(R.CUSTOMER_NAME,R.CUSTOMER_TYPE,R.DATE_OF_BIRTH,R.GENDER,R.PAN_NUMBER,
                                                    R.AADHAAR_NUMBER,R.EMAIL,R.MOBILE_NUMBER,R.ADDRESS,R.CITY,R.STATE,R.COUNTRY,R.RISK_CATEGORY)
                                                    =HASH (C.CUSTOMER_NAME,C.CUSTOMER_TYPE,C.DATE_OF_BIRTH,C.GENDER,C.PAN_NUMBER,
                                                    C.AADHAAR_NUMBER,C.EMAIL,C.MOBILE_NUMBER,C.ADDRESS,C.CITY,C.STATE,C.COUNTRY,C.RISK_CATEGORY)
                                                    THEN ''N''
                WHEN C.CUSTOMER_ID IS NOT NULL AND HASH(R.CUSTOMER_NAME,R.CUSTOMER_TYPE,R.DATE_OF_BIRTH,R.GENDER,R.PAN_NUMBER,
                                                    R.AADHAAR_NUMBER,R.EMAIL,R.MOBILE_NUMBER,R.ADDRESS,R.CITY,R.STATE,R.COUNTRY,R.RISK_CATEGORY)
                                                    <>HASH (C.CUSTOMER_NAME,C.CUSTOMER_TYPE,C.DATE_OF_BIRTH,C.GENDER,C.PAN_NUMBER,
                                                    C.AADHAAR_NUMBER,C.EMAIL,C.MOBILE_NUMBER,C.ADDRESS,C.CITY,C.STATE,C.COUNTRY,C.RISK_CATEGORY)
                                                    THEN ''U''
            END ACTN_CD
        FROM FIN_A.RAW.CUSTOMER_LOAD R
        LEFT JOIN FIN_A.SCH.DIM_CUSTOMER C
        ON R.CUSTOMER_ID=C.CUSTOMER_ID
        WHERE R.METADATA$ACTION=''INSERT'';
        
    END;
';