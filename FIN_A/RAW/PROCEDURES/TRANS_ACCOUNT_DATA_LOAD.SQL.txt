CREATE OR REPLACE PROCEDURE FIN_A.RAW.TRANS_ACCOUNT_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN

        DELETE FROM FIN_A.TRA.ACCOUNT_DATA;
        
        INSERT INTO FIN_A.TRA.ACCOUNT_DATA
        SELECT NVL(R.ACCOUNT_NUMBER,C.ACCOUNT_NUMBER),
                NVL(R.PAN_NUMBER,C.PAN_NUMBER),
                NVL(R.ACCOUNT_TYPE,C.ACCOUNT_TYPE),
                NVL(R.BRANCH_CODE,C.BRANCH_CODE),
                NVL(R.CURRENCY,C.CURRENCY),
                NVL(R.OPENING_DATE,C.OPENING_DATE),
                NVL(R.OPENING_BALANCE,C.OPENING_BALANCE),
            CASE
                WHEN C.ACCOUNT_NUMBER IS NULL THEN ''I''
                WHEN R.ACCOUNT_NUMBER IS NULL THEN ''D''
                WHEN HASH(R.PAN_NUMBER, R.ACCOUNT_TYPE, R.BRANCH_CODE,R.CURRENCY, R.OPENING_DATE, R.OPENING_BALANCE)
                    = HASH(C.PAN_NUMBER, C.ACCOUNT_TYPE, C.BRANCH_CODE,C.CURRENCY, C.OPENING_DATE, C.OPENING_BALANCE)
                    AND C.ACCOUNT_STATUS=''DORMANT'' THEN ''R''
                WHEN HASH(R.PAN_NUMBER, R.ACCOUNT_TYPE, R.BRANCH_CODE,R.CURRENCY, R.OPENING_DATE, R.OPENING_BALANCE)
                    = HASH(C.PAN_NUMBER, C.ACCOUNT_TYPE, C.BRANCH_CODE,C.CURRENCY, C.OPENING_DATE, C.OPENING_BALANCE) THEN ''N''
                WHEN HASH(R.PAN_NUMBER, R.ACCOUNT_TYPE, R.BRANCH_CODE,R.CURRENCY, R.OPENING_DATE, R.OPENING_BALANCE)
                    <> HASH(C.PAN_NUMBER, C.ACCOUNT_TYPE, C.BRANCH_CODE,C.CURRENCY, C.OPENING_DATE, C.OPENING_BALANCE) THEN ''U''
            END ACTN_CD
        FROM FIN_A.RAW.ACCOUNT_DATA_LOAD R
        FULL JOIN FIN_A.SCH.ACCOUNT_DATA C
        ON R.ACCOUNT_NUMBER=C.ACCOUNT_NUMBER;

        RETURN SQLROWCOUNT;
    END;
';