CREATE OR REPLACE PROCEDURE FIN_A.RAW.DAILY_BALANCE_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN
        INSERT INTO FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE
        WITH FACT_TRANS_DATA AS(
            SELECT ACCOUNT_ID,DATE(TRANSACTION_DATE) TRANSACTION_DATE,
                IFF(TRANSACTION_TYPE=''CREDIT'',SUM(TRANSACTION_AMOUNT),0) CREDIT,IFF(TRANSACTION_TYPE=''DEBIT'',SUM(TRANSACTION_AMOUNT),0) DEBIT,
            FROM FIN_A.SCH.TRANSACTION_LOAD WHERE TRANSACTION_STATUS=''SUCCESS'' AND METADATA$ACTION=''INSERT''
            AND DATE(TRANSACTION_DATE) NOT IN(SELECT DISTINCT BALANCE_DATE FROM FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE)
            GROUP BY ACCOUNT_ID,DATE(TRANSACTION_DATE),TRANSACTION_TYPE
        ),PROCESSED_DATA AS (
            SELECT TD.ACCOUNT_ID,TRANSACTION_DATE BALANCE_DATE,DA.OPENING_BALANCE,SUM(CREDIT) TOTAL_CREDIT,SUM(DEBIT) TOTAL_DEBIT
            FROM FACT_TRANS_DATA TD JOIN FIN_A.SCH.DIM_ACCOUNT DA ON TD.ACCOUNT_ID=DA.ACCOUNT_ID
            GROUP BY TD.ACCOUNT_ID,TRANSACTION_DATE,DA.OPENING_BALANCE
        ),LAST_DAILY_BALANCE AS (
            SELECT ACCOUNT_ID,BALANCE_DATE,CLOSING_BALANCE
            FROM FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE
            QUALIFY RANK() OVER( PARTITION BY ACCOUNT_ID ORDER BY BALANCE_DATE DESC)=1
        )
        SELECT PD.ACCOUNT_ID,PD.BALANCE_DATE,
            NVL(LB.CLOSING_BALANCE,PD.OPENING_BALANCE),
            PD.TOTAL_CREDIT,PD.TOTAL_DEBIT,
            NVL(LB.CLOSING_BALANCE,PD.OPENING_BALANCE)+PD.TOTAL_CREDIT-PD.TOTAL_DEBIT CLOSING_BALANCE
        FROM PROCESSED_DATA PD
        LEFT JOIN LAST_DAILY_BALANCE LB ON PD.ACCOUNT_ID=LB.ACCOUNT_ID;

        RETURN SQLROWCOUNT;
    END;
';