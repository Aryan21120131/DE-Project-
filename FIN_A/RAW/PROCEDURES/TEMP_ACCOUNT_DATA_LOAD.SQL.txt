CREATE OR REPLACE PROCEDURE FIN_A.RAW.TEMP_ACCOUNT_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN

        DELETE FROM FIN_A.TRA.DIM_ACCOUNT;
        
        INSERT INTO FIN_A.TRA.DIM_ACCOUNT
        SELECT R.*,
            CASE
                WHEN C.ACCOUNT_ID IS NULL THEN ''I''
                WHEN HASH(R.ACCOUNT_TYPE,R.CURRENCY,R.OPENING_DATE,R.OPENING_BALANCE,R.ACCOUNT_STATUS)=
                    HASH(C.ACCOUNT_TYPE,C.CURRENCY,C.OPENING_DATE,C.OPENING_BALANCE,C.ACCOUNT_STATUS) THEN ''N''
                WHEN HASH(R.ACCOUNT_TYPE,R.CURRENCY,R.OPENING_DATE,R.OPENING_BALANCE,R.ACCOUNT_STATUS)<>
                    HASH(C.ACCOUNT_TYPE,C.CURRENCY,C.OPENING_DATE,C.OPENING_BALANCE,C.ACCOUNT_STATUS) THEN ''U''
            END ACTION_CD
        FROM(SELECT CONCAT(C.CUSTOMER_ID,A.BRANCH_CODE,A.ACCOUNT_NUMBER) ACCOUNT_ID,
            C.CUSTOMER_ID,A.ACCOUNT_NUMBER,A.BRANCH_CODE,
            A.ACCOUNT_TYPE,A.CURRENCY,A.OPENING_DATE,A.OPENING_BALANCE,A.ACCOUNT_STATUS
        FROM FIN_A.SCH.ACCOUNT_DATA A
        JOIN FIN_A.SCH.DIM_CUSTOMER C ON C.PAN_NUMBER=A.PAN_NUMBER
        JOIN FIN_A.SCH.DIM_BRANCH B ON B.BRANCH_CODE=A.BRANCH_CODE) R
        FULL JOIN FIN_A.SCH.DIM_ACCOUNT C
        ON C.ACCOUNT_ID=R.ACCOUNT_ID;
    END;
';