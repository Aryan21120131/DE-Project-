CREATE OR REPLACE PROCEDURE FIN_A.RAW.CURATED_ACCOUNT_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN
    
        INSERT INTO FIN_A.SCH.ACCOUNT_DATA
        SELECT * EXCLUDE ACTN_CD,''ACTIVE'' FROM FIN_A.TRA.ACCOUNT_DATA WHERE ACTN_CD=''I'';

        LET I_CNT NUMBER := SQLROWCOUNT;
        
        LET N_CNT NUMBER := 0;
        
        SELECT COUNT(*) INTO :N_CNT FROM FIN_A.TRA.ACCOUNT_DATA WHERE ACTN_CD=''N'';
        
        UPDATE FIN_A.SCH.ACCOUNT_DATA C
        SET C.PAN_NUMBER=R.PAN_NUMBER,
            C.ACCOUNT_TYPE=R.ACCOUNT_TYPE,
            C.BRANCH_CODE=R.BRANCH_CODE,
            C.CURRENCY=R.CURRENCY,
            C.OPENING_DATE=R.OPENING_DATE,
            C.OPENING_BALANCE=R.OPENING_BALANCE
        FROM FIN_A.TRA.ACCOUNT_DATA R
        WHERE R.ACCOUNT_NUMBER=C.ACCOUNT_NUMBER AND ACTN_CD=''U'';

        LET U_CNT NUMBER := SQLROWCOUNT;

        UPDATE FIN_A.SCH.ACCOUNT_DATA C
        SET C.ACCOUNT_STATUS=''DORMANT''
        FROM FIN_A.TRA.ACCOUNT_DATA R
        WHERE R.ACCOUNT_NUMBER=C.ACCOUNT_NUMBER AND ACTN_CD=''D'';

        LET D_CNT NUMBER := SQLROWCOUNT;

        UPDATE FIN_A.SCH.ACCOUNT_DATA C
        SET C.ACCOUNT_STATUS=''ACTIVE''
        FROM FIN_A.TRA.ACCOUNT_DATA R
        WHERE R.ACCOUNT_NUMBER=C.ACCOUNT_NUMBER AND ACTN_CD=''R'';

        LET R_CNT NUMBER := SQLROWCOUNT;
        
        LET res VARCHAR := '' INSERT := ''|| I_CNT || '' NO CHANGE := '' || :N_CNT  || '' UPDATE := '' || U_CNT || '' DELETE : = '' || D_CNT || 
            '' REINSERT := '' || R_CNT;
        
        RETURN res;
    END;
';