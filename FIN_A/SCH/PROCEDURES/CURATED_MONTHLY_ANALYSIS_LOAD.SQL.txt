CREATE OR REPLACE PROCEDURE FIN_A.SCH.CURATED_MONTHLY_ANALYSIS_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN
        INSERT INTO FIN_A.SCH.FACT_ACCOUNT_ANALYTICS
        SELECT * EXCLUDE ACTN_CD FROM FIN_A.TRA.FACT_ACCOUNT_ANALYTICS WHERE ACTN_CD=''I'';

        LET I_CNT NUMBER := SQLROWCOUNT;

        UPDATE FIN_A.SCH.FACT_ACCOUNT_ANALYTICS C
        SET C.CURRENT_BALANCE=T.CURRENT_BALANCE,
            C.ANALYTICS_DATE=T.ANALYTICS_DATE,
            C.AVG_DAILY_BALANCE=T.AVG_DAILY_BALANCE,
            C.TOTAL_CREDIT_30_D=T.TOTAL_CREDIT_30_D,
            C.TOTAL_DEBIT_30_D=T.TOTAL_DEBIT_30_D,
            C.TRANSACTION_COUNT_30_D=T.TRANSACTION_COUNT_30_D,
            C.ACCOUNT_STATUS=T.ACCOUNT_STATUS
        FROM FIN_A.TRA.FACT_ACCOUNT_ANALYTICS T
        WHERE T.ACCOUNT_ID=C.ACCOUNT_ID 
            AND CONCAT(YEAR(C.ANALYTICS_DATE),MONTH(C.ANALYTICS_DATE))=CONCAT(YEAR(T.ANALYTICS_DATE),MONTH(T.ANALYTICS_DATE))
            AND T.ACTN_CD=''U'';

        LET U_CNT NUMBER := SQLROWCOUNT;
        
        RETURN ''INSERT := '' || I_CNT || '' UPDATE'' || U_CNT;
    END;
';