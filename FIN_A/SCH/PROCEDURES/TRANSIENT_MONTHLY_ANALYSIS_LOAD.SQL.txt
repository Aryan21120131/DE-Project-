CREATE OR REPLACE PROCEDURE FIN_A.SCH.TRANSIENT_MONTHLY_ANALYSIS_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN


        LET CNT NUMBER := 0;
        SELECT COUNT(*) INTO :CNT FROM FIN_A.SCH.DAILY_DATA_LOAD WHERE  METADATA$ACTION=''INSERT'';

        IF(CNT <=0) THEN
            RETURN ''No New Data Available'' || CNT;
        ELSE
        
        DELETE FROM FIN_A.TRA.FACT_ACCOUNT_ANALYTICS;
        
        INSERT INTO FIN_A.TRA.FACT_ACCOUNT_ANALYTICS
        WITH CRNT_BAL AS (
                    SELECT ACCOUNT_ID,CLOSING_BALANCE CURRENT_BALANCE,BALANCE_DATE,CONCAT(YEAR(BALANCE_DATE),MONTH(BALANCE_DATE)) YR_MNTH_KY
                    FROM FIN_A.SCH.DAILY_DATA_LOAD
                    WHERE METADATA$ACTION=''INSERT''
                    QUALIFY RANK() OVER( PARTITION BY ACCOUNT_ID ORDER BY BALANCE_DATE DESC)=1)
        , AVG_BAL AS(
            SELECT ACCOUNT_ID,AVG(CLOSING_BALANCE) AVG_DAILY_BALANCE 
            FROM FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE 
            WHERE CONCAT(YEAR(BALANCE_DATE),MONTH(BALANCE_DATE)) =(SELECT DISTINCT YR_MNTH_KY FROM CRNT_BAL)
            GROUP BY ACCOUNT_ID)
        , TRANS_DATA AS(
            SELECT ACCOUNT_ID,TRANSACTION_TYPE,
                IFF(TRANSACTION_TYPE=''DEBIT'', SUM(TRANSACTION_AMOUNT),0) TOTAL_DEBIT,
                IFF(TRANSACTION_TYPE=''CREDIT'', SUM(TRANSACTION_AMOUNT),0) TOTAL_CREDIT,
                COUNT(*) CNT,
            FROM FIN_A.SCH.FACT_TRANSACTION
            WHERE CONCAT(YEAR(TRANSACTION_DATE),MONTH(TRANSACTION_DATE)) = (SELECT DISTINCT YR_MNTH_KY FROM CRNT_BAL) 
                AND TRANSACTION_STATUS=''SUCCESS''
            GROUP BY ACCOUNT_ID,TRANSACTION_TYPE)
        , PROCESSED_DATA AS (
            SELECT ACCOUNT_ID,SUM(TOTAL_DEBIT) TOTAL_DEBIT_30_D,SUM(TOTAL_CREDIT) TOTAL_CREDIT_30_D,SUM(CNT) TRANSACTION_COUNT_30_D
            FROM TRANS_DATA GROUP BY ACCOUNT_ID)   
        , COMBINED_DATA AS (SELECT CB.ACCOUNT_ID,CB.BALANCE_DATE ANALYTICS_DATE,CB.CURRENT_BALANCE,AB.AVG_DAILY_BALANCE,TOTAL_CREDIT_30_D,
                TOTAL_DEBIT_30_D,TRANSACTION_COUNT_30_D,CB.YR_MNTH_KY,
                CASE
                    WHEN TRANSACTION_COUNT_30_D=0 THEN ''DORMANT''
                    WHEN CB.CURRENT_BALANCE<1000 THEN ''LOW_BALANCE''
                    ELSE ''ACTIVE''
                END
            FROM CRNT_BAL CB 
            JOIN AVG_BAL AB ON CB.ACCOUNT_ID=AB.ACCOUNT_ID 
            JOIN PROCESSED_DATA PD ON PD.ACCOUNT_ID=CB.ACCOUNT_ID)
        SELECT CD.* EXCLUDE YR_MNTH_KY,
                CASE
                    WHEN FA.ACCOUNT_ID IS NULL THEN ''I''
                    ELSE ''U''
                END ACTN_CD
        FROM COMBINED_DATA CD
        LEFT JOIN FIN_A.SCH.FACT_ACCOUNT_ANALYTICS FA
        ON CD.ACCOUNT_ID=FA.ACCOUNT_ID AND CD.YR_MNTH_KY=CONCAT(YEAR(FA.ANALYTICS_DATE),MONTH(FA.ANALYTICS_DATE));
        RETURN NVL(SQLROWCOUNT,0);
        END IF;
    END;
';