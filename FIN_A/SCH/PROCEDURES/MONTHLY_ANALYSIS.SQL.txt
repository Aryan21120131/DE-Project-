CREATE OR REPLACE PROCEDURE FIN_A.SCH.MONTHLY_ANALYSIS("DT" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN
        INSERT INTO FIN_A.SCH.FACT_ACCOUNT_ANALYTICS
        WITH CRNT_BAL AS (
            SELECT ACCOUNT_ID,CLOSING_BALANCE CURRENT_BALANCE
            FROM FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE
            WHERE YEAR(BALANCE_DATE)=YEAR(DATE(:DT)) AND MONTH(BALANCE_DATE)=MONTH(DATE(:DT))
            QUALIFY RANK() OVER( PARTITION BY ACCOUNT_ID ORDER BY BALANCE_DATE DESC)=1
        ), AVG_BAL AS(
            SELECT ACCOUNT_ID,AVG(CLOSING_BALANCE) AVG_DAILY_BALANCE FROM FIN_A.SCH.FACT_DAILY_ACCOUNT_BALANCE GROUP BY ACCOUNT_ID
        ), TRANS_DATA AS(
            SELECT ACCOUNT_ID,TRANSACTION_TYPE,
                IFF(TRANSACTION_TYPE=''DEBIT'', SUM(TRANSACTION_AMOUNT),0) TOTAL_DEBIT,
                IFF(TRANSACTION_TYPE=''CREDIT'', SUM(TRANSACTION_AMOUNT),0) TOTAL_CREDIT,
                COUNT(*) CNT,
            FROM FIN_A.SCH.FACT_TRANSACTION
            WHERE YEAR(TRANSACTION_DATE)=YEAR(DATE(:DT)) AND MONTH(TRANSACTION_DATE)=MONTH(DATE(:DT)) 
                AND TRANSACTION_STATUS=''SUCCESS''
            GROUP BY ACCOUNT_ID,TRANSACTION_TYPE
            ORDER BY ACCOUNT_ID,TRANSACTION_TYPE
        ), PROCESSED_DATA AS (
            SELECT ACCOUNT_ID,SUM(TOTAL_DEBIT) TOTAL_DEBIT_30_D,SUM(TOTAL_CREDIT) TOTAL_CREDIT_30_D,SUM(CNT) TRANSACTION_COUNT_30_D
            FROM TRANS_DATA GROUP BY ACCOUNT_ID
        )   
        SELECT CB.ACCOUNT_ID,LAST_DAY(DATE(:DT)) ANALYTICS_DATE,CB.CURRENT_BALANCE,AB.AVG_DAILY_BALANCE,TOTAL_CREDIT_30_D,
            TOTAL_DEBIT_30_D,TRANSACTION_COUNT_30_D,
            CASE
                WHEN TRANSACTION_COUNT_30_D=0 THEN ''DORMANT''
                WHEN CB.CURRENT_BALANCE<1000 THEN ''LOW_BALANCE''
                ELSE ''ACTIVE''
            END
        FROM CRNT_BAL CB JOIN AVG_BAL AB ON CB.ACCOUNT_ID=AB.ACCOUNT_ID JOIN PROCESSED_DATA PD ON PD.ACCOUNT_ID=CB.ACCOUNT_ID
        WHERE ANALYTICS_DATE NOT IN (SELECT ANALYTICS_DATE FROM FIN_A.SCH.FACT_ACCOUNT_ANALYTICS);
    END;
';