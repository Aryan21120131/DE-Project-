CREATE OR REPLACE PROCEDURE FIN_A.SCH.BRANCH_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    DECLARE 
        I_CNT NUMBER DEFAULT 0;
        N_CNT NUMBER DEFAULT 0;
        U_CNT NUMBER DEFAULT 0;
        D_CNT NUMBER DEFAULT 0;
        R_CNT NUMBER DEFAULT 0;
    BEGIN
        LET I_smt VARCHAR := ''INSERT INTO FIN_A.SCH.DIM_BRANCH(BRANCH_CODE,BRANCH_NAME,CITY,STATE,COUNTRY,IFSC_CODE,BRANCH_STATUS)
                    SELECT BRANCH_CODE,BRANCH_NAME,CITY,STATE,COUNTRY,IFSC_CODE,\\''ACTIVE\\''
                    FROM FIN_A.RAW.BRANCH_DATA_LOAD WHERE $7=\\''INSERT\\'' 
                    AND BRANCH_CODE NOT IN (SELECT BRANCH_CODE FROM FIN_A.SCH.DIM_BRANCH)'';

        EXECUTE IMMEDIATE :I_smt;
        
        I_CNT := SQLROWCOUNT;

        SELECT COUNT(*) INTO :N_CNT 
            FROM FIN_A.RAW.BRANCH_DATA_LOAD R
            LEFT JOIN FIN_A.SCH.DIM_BRANCH C
            WHERE R.$7=''INSERT'' AND HASH(C.BRANCH_CODE,C.BRANCH_NAME,C.CITY,C.STATE,C.COUNTRY,C.IFSC_CODE)
            =HASH(R.BRANCH_CODE,R.BRANCH_NAME,R.CITY,R.STATE,R.COUNTRY,R.IFSC_CODE);
        RETURN ''INSERT : '' || I_CNT || '' NO CHANGE : '' || N_CNT || '' UPDATE : '' || U_CNT || '' DELETE : '' || D_CNT || '' REINSERT : '' || R_CNT;
    END;
';