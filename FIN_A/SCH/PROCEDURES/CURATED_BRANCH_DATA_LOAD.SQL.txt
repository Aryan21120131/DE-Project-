CREATE OR REPLACE PROCEDURE FIN_A.SCH.CURATED_BRANCH_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    DECLARE
        I_CNT NUMBER DEFAULT 0;
        N_CNT NUMBER DEFAULT 0;
        U_CNT NUMBER DEFAULT 0;
        D_CNT NUMBER DEFAULT 0;
        R_CNT NUMBER DEFAULT 0;
    BEGIN
        LET I_smt VARCHAR := ''INSERT INTO FIN_A.SCH.DIM_BRANCH(BRANCH_CODE,BRANCH_NAME,CITY,STATE,COUNTRY,IFSC_CODE,BRANCH_STATUS)
                                SELECT BRANCH_CODE,BRANCH_NAME,CITY,STATE,COUNTRY,IFSC_CODE,\\''ACTIVE\\''
                                FROM FIN_A.TRA.DIM_BRANCH WHERE ACTN_CD=\\''I\\'''';

        EXECUTE IMMEDIATE :I_smt;
        I_CNT := SQLROWCOUNT;

        SELECT COUNT(*) INTO :N_CNT FROM FIN_A.TRA.DIM_BRANCH T WHERE ACTN_CD=''N'';

        LET U_smt VARCHAR := ''UPDATE FIN_A.SCH.DIM_BRANCH C
        SET C.BRANCH_NAME=R.BRANCH_NAME,C.CITY=R.CITY,C.STATE=R.STATE,C.COUNTRY=R.COUNTRY,C.IFSC_CODE=R.IFSC_CODE
        FROM FIN_A.TRA.DIM_BRANCH R
        WHERE R.BRANCH_CODE=C.BRANCH_CODE AND ACTN_CD=\\''U\\'''';

        EXECUTE IMMEDIATE :U_smt;
        U_CNT := SQLROWCOUNT;

        LET D_smt := ''UPDATE FIN_A.SCH.DIM_BRANCH C
                        SET C.BRANCH_STATUS=\\''INACTIVE\\''
                        FROM FIN_A.TRA.DIM_BRANCH R
                        WHERE R.BRANCH_CODE=C.BRANCH_CODE AND ACTN_CD=\\''D\\'''';

        EXECUTE IMMEDIATE :D_smt;
        D_CNT := SQLROWCOUNT;

        LET R_smt := ''UPDATE FIN_A.SCH.DIM_BRANCH C
                        SET C.BRANCH_STATUS=\\''ACTIVE\\''
                        FROM FIN_A.TRA.DIM_BRANCH R
                        WHERE R.BRANCH_CODE=C.BRANCH_CODE AND ACTN_CD=\\''R\\'''';

        EXECUTE IMMEDIATE :R_smt;
        R_CNT := SQLROWCOUNT;

        RETURN ''INSERT : '' || I_CNT || '' NO CHANGE : '' || N_CNT || '' UPDATE : '' || U_CNT || '' DELETE : '' || D_CNT || '' REINSERT : '' || R_CNT;
    END
';