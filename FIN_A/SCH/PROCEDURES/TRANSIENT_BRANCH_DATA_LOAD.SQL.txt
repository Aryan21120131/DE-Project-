CREATE OR REPLACE PROCEDURE FIN_A.SCH.TRANSIENT_BRANCH_DATA_LOAD()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '
    BEGIN
        DELETE FROM FIN_A.TRA.DIM_BRANCH;
        
        INSERT INTO FIN_A.TRA.DIM_BRANCH(BRANCH_CODE,BRANCH_NAME,CITY,STATE,COUNTRY,IFSC_CODE,ACTN_CD)
        SELECT NVL(R.BRANCH_CODE,C.BRANCH_CODE),
            NVL(R.BRANCH_NAME,C.BRANCH_NAME),
            NVL(R.CITY,C.CITY),
            NVL(R.STATE,C.STATE),
            NVL(R.COUNTRY,C.COUNTRY),
            NVL(R.IFSC_CODE,C.IFSC_CODE),
            CASE
                WHEN C.BRANCH_CODE IS NULL THEN ''I''
                WHEN R.BRANCH_CODE IS NULL THEN ''D''
                WHEN HASH(C.BRANCH_CODE,C.BRANCH_NAME,C.CITY,C.STATE,C.COUNTRY,C.IFSC_CODE)=
                        HASH(R.BRANCH_CODE,R.BRANCH_NAME,R.CITY,R.STATE,R.COUNTRY,R.IFSC_CODE) AND C.BRANCH_STATUS=''INACTIVE''
                    THEN ''R''
                WHEN HASH(C.BRANCH_CODE,C.BRANCH_NAME,C.CITY,C.STATE,C.COUNTRY,C.IFSC_CODE)=
                        HASH(R.BRANCH_CODE,R.BRANCH_NAME,R.CITY,R.STATE,R.COUNTRY,R.IFSC_CODE)
                    THEN ''N''
                WHEN HASH(C.BRANCH_CODE,C.BRANCH_NAME,C.CITY,C.STATE,C.COUNTRY,C.IFSC_CODE)<>
                    HASH(R.BRANCH_CODE,R.BRANCH_NAME,R.CITY,R.STATE,R.COUNTRY,R.IFSC_CODE)
                THEN ''U''
            END ACTN_CD
        FROM FIN_A.RAW.BRANCH_DATA_LOAD R
        FULL JOIN FIN_A.SCH.DIM_BRANCH C
        ON R.BRANCH_CODE=C.BRANCH_CODE;
    END;
';